name: Translation Workflow

on:
  push:
    branches: [main, ags/translation-action]

jobs:
  translate:
    runs-on: ubuntu-latest
    
    services:
      libretranslate:
        image: libretranslate/libretranslate:v1.3.11
        ports:
          - 9999:5000
        env:
          LT_LOAD_ONLY: "en,es"
          LT_DISABLE_FILES_TRANSLATION: "true"
          LT_DISABLE_WEB_UI: "true"
          
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
    
      - name: Setup
        uses: ./.github/actions/setup-all
        
      - name: Debug container status
        run: |
          echo "=== Docker container status ==="
          docker ps -a
          echo "=== LibreTranslate container logs ==="
          docker logs $(docker ps -q --filter "ancestor=libretranslate/libretranslate:v1.3.11") || echo "No logs available"
          
      - name: Wait for LibreTranslate to be ready
        run: |
          echo "Waiting for LibreTranslate service to be ready..."
          echo "This may take several minutes as language models are downloaded..."
          
          # Wait up to 10 minutes with better logging
          for i in {1..60}; do
            echo "Attempt $i/60: Checking if LibreTranslate is ready..."
            
            if curl -s -f http://localhost:9999/languages > /dev/null 2>&1; then
              echo "✅ LibreTranslate is ready!"
              curl -s http://localhost:9999/languages | jq . || curl -s http://localhost:9999/languages
              break
            fi
            
            if [ $i -eq 60 ]; then
              echo "❌ LibreTranslate failed to start after 10 minutes"
              echo "=== Final container logs ==="
              docker logs $(docker ps -q --filter "ancestor=libretranslate/libretranslate:v1.3.11") || echo "No logs available"
              exit 1
            fi
            
            echo "Still waiting... (attempt $i/60)"
            sleep 10
          done
          
      - name: Test LibreTranslate connection
        run: |
          echo "Testing LibreTranslate API..."
          curl -X GET http://localhost:9999/languages

      - name: Run translation tasks
        run: mix getext.translate

      - name: Commit and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git add priv/gettext
          git commit -m "AUTOMATED TRANSLATIONS" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref }}
